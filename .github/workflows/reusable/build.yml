name: Build Docker Images (Reusable)

on:
  workflow_call:
    inputs:
      image_tag:
        required: false
        type: string
        description: 'Custom image tag (optional)'
    outputs:
      image-digest:
        description: 'Docker image digest'
        value: ${{ jobs.build.outputs.image-digest }}
      image-tag:
        description: 'Docker image tag'
        value: ${{ jobs.build.outputs.image-tag }}

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.meta.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file for Docker Compose
        run: |
          cat > .env << EOF
          # Database
          POSTGRES_USER=procureflow
          POSTGRES_PASSWORD=procureflow
          POSTGRES_DB=procureflow_db
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          DATABASE_URL=jdbc:postgresql://postgres:5432/procureflow_db
          
          # Application
          APP_NAME=procureflow
          APP_LOCALE=en-US
          
          # Frontend
          NEXT_PUBLIC_GRAPHQL_URL=http://router:4000/graphql
          
          # Grafana
          GF_SECURITY_ADMIN_USER=admin
          GF_SECURITY_ADMIN_PASSWORD=admin
          
          # AI (sensitive - from secrets)
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          EOF

      - name: Build Docker images
        working-directory: infra/docker
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
        run: docker compose -f docker-compose.yml build --no-cache

      - name: Get image metadata
        id: meta
        run: |
          IMAGE_DIGEST=$(docker images --format "{{.ID}}" | head -1)
          if [ -n "${{ inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            IMAGE_TAG="pr-${{ github.event.pull_request.number }}-${{ github.sha }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            IMAGE_TAG="main-${{ github.sha }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi
          echo "digest=$IMAGE_DIGEST" >> $GITHUB_OUTPUT
          echo "tags=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Verify images
        run: |
          echo "Built Docker images:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | head -10
          echo "All required images built successfully"
          echo "Image digest: ${{ steps.meta.outputs.digest }}"
          echo "Image tag: ${{ steps.meta.outputs.tags }}"

      - name: Save build artifacts
        run: |
          echo "Build completed at $(date)" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build-info.txt
          echo "PR: ${{ github.event.pull_request.number }}" >> build-info.txt
          echo "Image Digest: ${{ steps.meta.outputs.digest }}" >> build-info.txt
          echo "Image Tag: ${{ steps.meta.outputs.tags }}" >> build-info.txt

      - name: Save image list
        run: |
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "(procureflow|app|assistant|security|web)" > image-list.txt || true
          echo "Images built:" && cat image-list.txt || echo "No custom images found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.event.pull_request.number || github.sha }}
          path: |
            build-info.txt
            image-list.txt
          retention-days: 7

