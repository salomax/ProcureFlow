name: CI - Quality Checks & Build

on:
  pull_request:
    branches: ['**']
  push:
    branches:
      - main
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.event.workflow_run.head_branch || 'manual' }}
  cancel-in-progress: true

env:
  CI: true
  NEXT_TELEMETRY_DISABLED: 1
  TESTCONTAINERS_RYUK_DISABLED: true

jobs:
  # ============================================
  # Backend Tests (Matrix)
  # ============================================
  backend-tests:
    name: Backend Tests (${{ matrix.service }})
    strategy:
      matrix:
        service: [app, assistant, security, common]
      fail-fast: false
    uses: ./reusable/backend-tests.yml
    with:
      service: ${{ matrix.service }}

  # ============================================
  # Frontend Tests
  # ============================================
  frontend-tests:
    name: Frontend Tests
    uses: ./reusable/frontend-tests.yml

  # ============================================
  # Security Scan
  # ============================================
  security-scan:
    name: Security Scan
    uses: ./reusable/security-scan.yml

  # ============================================
  # Build Docker Images
  # ============================================
  build:
    name: Build Docker Images
    needs: [backend-tests, frontend-tests, security-scan]
    uses: ./reusable/build.yml
    secrets: inherit

