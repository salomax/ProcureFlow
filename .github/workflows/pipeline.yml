name: CI/CD Pipeline

on:
  pull_request:
    branches: ['**']
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  release:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  NEXT_TELEMETRY_DISABLED: 1
  TESTCONTAINERS_RYUK_DISABLED: true

jobs:
  # ============================================
  # PR CI: Quality Checks & Security Scan
  # ============================================
  backend-tests:
    name: Backend Tests (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [app, assistant, security, common]
      fail-fast: false
    services:
      docker:
        image: docker:dind
        options: --privileged
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            service/kotlin/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('service/kotlin/**/*.gradle*', 'service/kotlin/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run unit tests
        working-directory: ./service/kotlin
        env:
          ryuk.disabled: 'true'
          TESTCONTAINERS_RYUK_DISABLED: 'true'
        run: ./gradlew :${{ matrix.service }}:test --no-daemon

      - name: Run integration tests
        if: matrix.service != 'common'
        working-directory: ./service/kotlin
        env:
          ryuk.disabled: 'true'
          TESTCONTAINERS_RYUK_DISABLED: 'true'
        run: ./gradlew :${{ matrix.service }}:testIntegration --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results-${{ matrix.service }}
          path: |
            service/kotlin/${{ matrix.service }}/build/test-results/**/*.xml
          retention-days: 7

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.16.0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: web/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm run typecheck

      - name: Lint
        run: pnpm run lint --max-warnings=0

      - name: Run unit tests
        run: pnpm run test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: |
            web/coverage
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Mock security scan summary
        run: |
          echo "üîí Security scan completed"
          echo "‚úÖ No critical vulnerabilities found"
          echo "üìä Scan results uploaded to GitHub Security tab"

  # ============================================
  # PR CI: Build & Preview App (Ephemeral)
  # ============================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, security-scan]
    outputs:
      image-digest: ${{ steps.meta.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file for Docker Compose
        run: |
          cat > .env << EOF
          # Database
          POSTGRES_USER=procureflow
          POSTGRES_PASSWORD=procureflow
          POSTGRES_DB=procureflow_db
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          DATABASE_URL=jdbc:postgresql://postgres:5432/procureflow_db
          
          # Application
          APP_NAME=procureflow
          APP_LOCALE=en-US
          
          # Frontend
          NEXT_PUBLIC_GRAPHQL_URL=http://router:4000/graphql
          
          # Grafana
          GF_SECURITY_ADMIN_USER=admin
          GF_SECURITY_ADMIN_PASSWORD=admin
          
          # AI (sensitive - from secrets)
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          EOF

      - name: Build Docker images
        working-directory: infra/docker
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
        run: docker compose -f docker-compose.yml build --no-cache

      - name: Get image metadata
        id: meta
        run: |
          IMAGE_DIGEST=$(docker images --format "{{.ID}}" | head -1)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            IMAGE_TAG="pr-${{ github.event.pull_request.number }}-${{ github.sha }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            IMAGE_TAG="main-${{ github.sha }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi
          echo "digest=$IMAGE_DIGEST" >> $GITHUB_OUTPUT
          echo "tags=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Verify images
        run: |
          echo "Built Docker images:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | head -10
          echo "All required images built successfully"
          echo "Image digest: ${{ steps.meta.outputs.digest }}"
          echo "Image tag: ${{ steps.meta.outputs.tags }}"

      - name: Save build artifacts
        run: |
          echo "Build completed at $(date)" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build-info.txt
          echo "PR: ${{ github.event.pull_request.number }}" >> build-info.txt
          echo "Image Digest: ${{ steps.meta.outputs.digest }}" >> build-info.txt
          echo "Image Tag: ${{ steps.meta.outputs.tags }}" >> build-info.txt

      - name: Save image list
        run: |
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "(procureflow|app|assistant|security|web)" > image-list.txt || true
          echo "Images built:" && cat image-list.txt || echo "No custom images found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.event.pull_request.number || github.sha }}
          path: |
            build-info.txt
            image-list.txt
          retention-days: 7

  preview-deploy:
    name: Deploy Preview App (Mocked)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request'
    environment:
      name: preview-pr-${{ github.event.pull_request.number }}
      url: https://preview-pr-${{ github.event.pull_request.number }}.example.com
    steps:
      - name: Mock Preview Deployment
        run: |
          echo "üöÄ Deploying Preview App for PR #${{ github.event.pull_request.number }}"
          echo "üì¶ Using image digest: ${{ needs.build.outputs.image-digest }}"
          echo "üè∑Ô∏è  Using image tag: ${{ needs.build.outputs.image-tag }}"
          echo ""
          echo "‚úÖ Preview environment would be deployed to:"
          echo "   URL: https://preview-pr-${{ github.event.pull_request.number }}.example.com"
          echo "   Environment: preview-pr-${{ github.event.pull_request.number }}"
          echo ""
          echo "‚è±Ô∏è  Simulating deployment (30s)..."
          sleep 30
          echo "‚úÖ Preview app deployed successfully"
          echo "üîç Preview app is ready for validation"

      - name: Mock Preview Validation
        run: |
          echo "üß™ Running automated validation on preview app..."
          echo "‚úÖ Health checks passed"
          echo "‚úÖ Smoke tests passed"
          echo "‚úÖ Preview app is healthy and ready for review"

      - name: Comment PR with Preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Preview App Deployed**\n\nüîó Preview URL: https://preview-pr-${{ github.event.pull_request.number }}.example.com\nüì¶ Image Digest: `${{ needs.build.outputs.image-digest }}`\n\nPlease review the preview app before approving this PR.'
            });

  # ============================================
  # Staging: Deploy on merge to main
  # ============================================
  staging-deploy:
    name: Deploy to Staging (Mocked)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifacts-*
          merge-multiple: true

      - name: Mock Staging Deployment
        run: |
          echo "üöÄ Deploying to Staging environment"
          echo "üì¶ Using image digest: ${{ needs.build.outputs.image-digest }}"
          echo "üè∑Ô∏è  Using image tag: ${{ needs.build.outputs.image-tag }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo ""
          echo "‚úÖ Staging environment would be deployed to:"
          echo "   Environment: staging"
          echo "   URL: https://staging.example.com"
          echo ""
          echo "‚è±Ô∏è  Simulating deployment (45s)..."
          sleep 45
          echo "‚úÖ Staging deployment completed"
          
      - name: Save staging deployment info
        run: |
          echo "STAGING_IMAGE_DIGEST=${{ needs.build.outputs.image-digest }}" >> $GITHUB_ENV
          echo "STAGING_IMAGE_TAG=${{ needs.build.outputs.image-tag }}" >> $GITHUB_ENV

      - name: Mock Database Migrations
        run: |
          echo "üóÑÔ∏è  Running database migrations..."
          echo "‚úÖ Migration: 001_initial_schema.sql - Applied"
          echo "‚úÖ Migration: 002_add_catalog_items.sql - Applied"
          echo "‚úÖ All migrations completed successfully"

      - name: Run Smoke Tests
        run: |
          echo "üß™ Running smoke tests on staging..."
          echo "‚úÖ Health check: /health - OK"
          echo "‚úÖ GraphQL endpoint: /graphql - OK"
          echo "‚úÖ Database connection: OK"
          echo "‚úÖ All smoke tests passed"

      - name: Run E2E Tests
        run: |
          echo "üß™ Running E2E tests on staging..."
          echo "‚úÖ Test: Catalog search - PASSED"
          echo "‚úÖ Test: Add to cart - PASSED"
          echo "‚úÖ Test: Checkout flow - PASSED"
          echo "‚úÖ Test: AI chat - PASSED"
          echo "‚úÖ All E2E tests passed"

      - name: Run Contract Tests
        run: |
          echo "üß™ Running GraphQL contract tests..."
          echo "‚úÖ Contract: searchCatalogItems - Valid"
          echo "‚úÖ Contract: catalogItem - Valid"
          echo "‚úÖ Contract: chat - Valid"
          echo "‚úÖ All contract tests passed"

      - name: Observability Checks
        run: |
          echo "üìä Running observability checks..."
          echo "‚úÖ Metrics endpoint: /prometheus - OK"
          echo "‚úÖ Logs collection: OK"
          echo "‚úÖ Tracing: OK"
          echo "‚úÖ All observability checks passed"

      - name: Staging Validation Summary
        run: |
          echo "‚úÖ Staging deployment validated successfully"
          echo "üì¶ Image digest: ${{ needs.build.outputs.image-digest }}"
          echo "üîó Staging URL: https://staging.example.com"
          echo "‚úÖ Ready for production promotion"

  # ============================================
  # Production: Deploy on tag/release
  # ============================================
  production-deploy:
    name: Deploy to Production (Mocked)
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifacts-*
          merge-multiple: true

      - name: Mock Production Deployment (Canary)
        run: |
          echo "üöÄ Deploying to Production (Canary Rollout)"
          echo "üì¶ Using image digest: ${{ needs.build.outputs.image-digest }}"
          echo "üè∑Ô∏è  Version: ${{ steps.tag.outputs.version }}"
          echo "üìù Promoting same digest from staging to production"
          echo ""
          echo "‚úÖ Production environment would be deployed to:"
          echo "   Environment: production"
          echo "   URL: https://prod.example.com"
          echo ""
          echo "üìä Canary rollout strategy:"
          echo "   1. Deploy 10% traffic to canary"
          echo "   2. Monitor metrics for 5 minutes"
          echo "   3. If healthy, increase to 50%"
          echo "   4. Monitor metrics for 5 minutes"
          echo "   5. If healthy, complete rollout to 100%"
          echo ""
          echo "‚è±Ô∏è  Simulating canary deployment..."
          sleep 60
          echo "‚úÖ Canary deployment completed"

      - name: Post-Release Health Checks
        run: |
          echo "üè• Running post-release health checks..."
          echo "‚úÖ Health check: /health - OK (200ms)"
          echo "‚úÖ Error rate: 0.01% (below threshold)"
          echo "‚úÖ Response time: 150ms (p95)"
          echo "‚úÖ Database connections: Healthy"
          echo "‚úÖ All health checks passed"

      - name: SLO/SLA Monitoring
        run: |
          echo "üìä Monitoring SLO/SLA metrics..."
          echo "‚úÖ Availability: 99.9% (target: 99.9%)"
          echo "‚úÖ Latency p95: 150ms (target: 200ms)"
          echo "‚úÖ Error rate: 0.01% (target: 0.1%)"
          echo "‚úÖ All SLO/SLA targets met"

      - name: Production Deployment Summary
        run: |
          echo "‚úÖ Production deployment completed successfully"
          echo "üì¶ Image digest: ${{ needs.build.outputs.image-digest }}"
          echo "üè∑Ô∏è  Version: ${{ steps.tag.outputs.version }}"
          echo "üîó Production URL: https://prod.example.com"
          echo "üìä Deployment strategy: Canary (100% complete)"
          echo "‚úÖ All health checks and SLOs passed"

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.tag.outputs.version }}';
            const digest = '${{ needs.build.outputs.image-digest }}';
            
            github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: `Release ${version}`,
              body: `## Release ${version}\n\n‚úÖ Deployed to production\nüì¶ Image Digest: \`${digest}\`\nüîó Production URL: https://prod.example.com\n\n### Deployment Details\n- Strategy: Canary Rollout\n- Status: ‚úÖ Healthy\n- All health checks passed\n- SLO/SLA targets met`,
              draft: false,
              prerelease: false
            });

  # ============================================
  # Production: Auto-Rollback (if unhealthy)
  # ============================================
  production-rollback:
    name: Auto-Rollback (Mocked)
    runs-on: ubuntu-latest
    needs: [production-deploy]
    if: failure() && (startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release')
    environment:
      name: production
    steps:
      - name: Get version tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Mock Auto-Rollback
        run: |
          echo "‚ö†Ô∏è  Production deployment unhealthy - Initiating rollback"
          echo "üì¶ Rolling back to previous image digest"
          echo "üè∑Ô∏è  Version being rolled back: ${{ steps.tag.outputs.version }}"
          echo "‚è±Ô∏è  Simulating rollback (30s)..."
          sleep 30
          echo "‚úÖ Rollback completed"
          echo "üîó Production URL: https://prod.example.com (previous version)"

      - name: Notify Rollback
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.tag.outputs.version }}';
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Production Rollback: ${version}`,
              body: `Production deployment was automatically rolled back due to health check failures.\n\nVersion: ${version}\n\nPlease investigate and create a new PR with fixes.`,
              labels: ['rollback', 'production', 'urgent']
            });



