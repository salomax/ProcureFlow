# Start by using the official Gradle image with JDK 21 as our builder stage.
FROM gradle:8.10.2-jdk21 AS build

# Set the working directory inside the container for the build process.
WORKDIR /home/gradle/project

# Copy Gradle wrapper and build files first for better layer caching
COPY gradlew ./
COPY gradle ./gradle
COPY build.gradle.kts settings.gradle.kts gradle.properties ./

# Copy common module first (shared dependency)
COPY common/build.gradle.kts ./common/
COPY common/src ./common/src

# Copy security module build files
COPY security/build.gradle.kts ./security/
COPY security/src ./security/src

# Download dependencies and build common module first (shared by all services)
# This maximizes cache reuse across all service builds
# Using BuildKit cache mount to share Gradle cache between builds
RUN --mount=type=cache,target=/home/gradle/.gradle/caches \
    --mount=type=cache,target=/home/gradle/.gradle/wrapper \
    ./gradlew :common:build -x test --build-cache

# Build the application JAR
# - './gradlew :security:shadowJar': Executes the `shadowJar` task on the `:security` module. This task typically
#   creates an "uber" or "fat" JAR containing the application code and all its dependencies.
# - '-x test': Skips running any tests during the build.
# - '--build-cache': Uses the Gradle build cache for faster incremental builds
# - '--parallel': Builds modules in parallel for better performance
RUN --mount=type=cache,target=/home/gradle/.gradle/caches \
    --mount=type=cache,target=/home/gradle/.gradle/wrapper \
    ./gradlew :security:shadowJar -x test --build-cache --parallel

# Use a minimal JRE (Java Runtime Environment) image based on Eclipse Temurin with JDK 21.
# This image is much smaller than the full JDK image used for building.
FROM eclipse-temurin:21-jre

# Set the working directory for the application inside the final image.
WORKDIR /security

# Copy the generated "fat JAR" from the 'build' stage to the final image's working directory.
# - 'COPY --from=build': Specifies that the file should be copied from the stage named 'build'.
# - '/home/gradle/project/security/build/libs/security-all.jar': The path to the built JAR file in the 'build' container.
# - '/security/service.jar': The destination path and name in the final container.
COPY --from=build /home/gradle/project/security/build/libs/security-all.jar /security/service.jar

# Inform Docker that the container will listen on the specified port at runtime.
# This is documentation and does not actually publish the port; it's a metadata instruction.
EXPOSE 8080

# Define the command that runs when the container starts.
# - '["java","-jar","/app/service.jar"]': Executes the JAR file using the Java Runtime.
ENTRYPOINT ["java","-jar","/security/service.jar"]
